---
작성일: "2023-08-10 23:34"
링크: https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=276041776
---
#개발서적 #대규모시스템설계기초
## 연결문서
- [[1장 사용자 수에 따른 규모 확장성]]

## 정리
저장할 데이터가 많아지면 데이터베이스의 부하도 증가하고 서비스가 느려지게 된다.  
이러한 경우에 데이터베이스를 증설하는 방법을 찾아야 한다.
### 수직적 확장 vs 수평적 확장
![2020230814160518.png|500](./images/Pasted%20image%2020230814160518.png)
#### 수직적 확장
스케일 업이라고 하는 확장 방식으로 CPU, 메모리, 디스크 등의 하드웨어를 증설하는 방법이다.  
즉, 물리적인 하드웨어의 성능을 높여서 처리량을 늘리는 방법이다 [^1]. 

스케일 업에는 삼약한 약점이 존재한다.
1. 하드웨어는 무한정 늘릴 수도 없고 비용을 감당하기 힘들다.
2. 단일 장애 지점(SPOF)로 인한 위험성이 크다.
3. 가용성을 책임질 수 없다.
#### 수평적 확장
스케일 아웃이라고 하는 확장 방식으로 DB에서는 샤딩(sharding)이라고 부르며 서버를 증설하는 방법으로 처리량을 올린다.  
웹 계층에서는 스케일 아웃은 동일한 서비스를 실행한 서버를 추가하는 방식을 말하는데 샤딩은 조금 다르게 동작한다.  
데이터 계층의 확장은 보통 데이터가 많아져 생기는 문제로 동일한 데이터를 가진 서버를 증설하는 것은 효용이 떨어지기 때문이다.

샤딩은 대규모 데이터베이스를 샤드(shard)라고 부르는 작은 단위로 분할하는 기술을 일컫는다.  
모든 샤드는 같은 스키마를 쓰지만 샤드마다 보관되는 데이터는 서로 다르다.

예를 들어보자 20만개의 데이터가 4개의 샤드로 샤딩된 데이터베이스가 있다고 하자.
샤딩 전략은  `id % 4`로 나머지에 따라 저장한다.
![2020230814160754.png|500](./images/Pasted%20image%2020230814160754.png)
- 나머지가 0 이라면 1번 샤드  ->  [0, 4, 8, 12 ...] 
- 나머지가 1 이라면 2번 샤드 -> [1, 5, 9, 13 ...] 
- 나머지가 2 이라면 3번 샤드 -> [2, 6, 10, 14 ...] 
- 나머지가 3 이라면 4번 샤드 -> [3, 7, 11, 15 ...] 
### 샤딩시 고려해야 하는 점
샤딩 전략에서 가장 중요한 것은 샤딩 키(sharding key)를 어떻게 정하느냐 하는 것이다. (샤딩 키는 파티션 키라고도 부른다.)  
샤딩 키를 정할 때는 데이터를 고르게 분할 할 수 있도록 하는게 가장 중요하다.  
샤딩은 좋은 기술이지만 몇가지 문제를 고려해야한다.

- 데이터의 재 샤딩: 재 샤딩은 다음과 같은 경우 필요하다.
	1. 데이터가 너무 많아져 하나의 샤드로는 더 이상 감당하기 어려울 때
	2. 샤드간 데이터 분포가 균등하지 못하여 특정 샤드에 부하가 몰리거나 디스크 공간이 부족할 때
	이러한 경우 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치하는 전략을 사용해야한다.
	
- 유명인사 문제: 핫스팟 키(hotspot key) 문제라고도 부르는데 호출이 빈번한 데이터가 하나의 샤드에 집중된 경우 발생한다.
	- ex) sns 서비스에서 유명인사의 게시물이 하나의 샤드에 몰려 있는 상황.
	
- 조인과 비정규화: 하나의 데이터베이스를 샤딩하고 나면 여러 샤드에 걸치 데이터간에 join을 하기 어려워 진다. 이를 해결하는 한가지 방법을 데이터베이스를 비정규화하여 join을 없이 질의가 가능하도록 하는 것이다.
### 샤딩까지 적용된 설계안
![2020230814161003.png|500](./images/Pasted%20image%2020230814161003.png)



[^1]: 스택오버플로는 2013년 한 해 동안 방문자 천만 명의 트래픽을 전부 한대의 마스터 DB로 처리했다고 한다. 